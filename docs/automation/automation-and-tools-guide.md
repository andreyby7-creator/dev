# Автоматизация и инструменты - Руководство

## Назначение

Система автоматизации и инструментов для проекта SaleSpot BY, включающая codemods, анализ дублирования, оптимизацию импортов и настройки tree-shaking.

## Основные компоненты

### 1. Codemods

**Функциональность:**

- **any-to-unknown**: Замена any типов на unknown
- **add-types**: Добавление типов для переменных и функций
- **import-optimization**: Оптимизация и сортировка импортов

**Использование:**

```bash
# Основной скрипт
./scripts/codemods.sh --help

# Исправление any типов
./scripts/codemods.sh --any

# Добавление типов
./scripts/codemods.sh --typing

# Оптимизация импортов
./scripts/codemods.sh --imports

# Все исправления
./scripts/codemods.sh --all
```

### 2. JSCodeshift

**Функциональность:**

- Автоматизация изменений AST
- TypeScript и JavaScript файлы (.ts, .tsx, .js, .jsx)
- Автоматическое резервное копирование
- Откат изменений

**Установка:**

```bash
pnpm add -g jscodeshift
```

### 3. TS-Morph

**Функциональность:**

- TypeScript API для работы с AST
- Анализ TypeScript кода
- Автоматические изменения
- Валидация типов и рефакторинг

### 4. Анализ дублирования

**Функциональность:**

- Автоматический анализ дублирования кода
- Процент дублирования по файлам
- Общая статистика дублирования
- Рекомендации по оптимизации

**Использование:**

```bash
./scripts/quality/import-optimizer.sh
```

### 5. Оптимизация импортов

**Функциональность:**

- Сортировка импортов по группам
- Удаление неиспользуемых импортов
- Анализ циклических зависимостей
- Группировка по типам (built-in, external, internal)

**Правила сортировки:**

```typescript
// 1. Built-in модули
import { Injectable } from '@nestjs/common';

// 2. External зависимости
import { z } from 'zod';

// 3. Internal модули
import { UserService } from './user.service';

// 4. Type imports
import type { User } from './user.types';
```

### 6. Tree-shaking и минимизация

**Функциональность:**

- Оптимизация production сборок
- Webpack оптимизация
- Next.js экспериментальные функции
- Анализ размера бандлов
- Оптимизация зависимостей

**Использование:**

```bash
./scripts/quality/bundle-optimizer.sh
```

## AstCodeModService

### Основные возможности

- **Массовые трансформации**: Применение правил к множеству файлов
- **Предопределенные правила**: Готовые шаблоны для типичных изменений
- **История изменений**: Отслеживание всех выполненных трансформаций
- **Валидация**: Проверка корректности изменений
- **Откат**: Возможность отменить изменения

### API методы

```typescript
// Выполнение массовой трансформации
performBulkTransformation(request: IBulkTransformationRequest): Promise<IBulkTransformationResult>

// Получение предопределенных правил
getPredefinedRules(): ITransformationRule[]

// Получение истории трансформаций
getTransformationHistory(): ICodeTransformation[]
```

### Предопределенные правила

1. **add-logger-to-service**: Добавление Logger в сервисы
2. **add-error-handling**: Добавление обработки ошибок
3. **convert-to-async**: Конвертация в async/await
4. **add-validation**: Добавление Zod валидации
5. **optimize-imports**: Оптимизация импортов

## Скрипты автоматизации

### 1. codemods.sh

**Функциональность:**

- Проверка зависимостей
- Выполнение трансформаций
- Резервное копирование
- Откат изменений

### 2. import-optimizer.sh

**Функциональность:**

- Анализ дублирования
- Оптимизация импортов
- Анализ неиспользуемых импортов
- Проверка циклических зависимостей

### 3. bundle-optimizer.sh

**Функциональность:**

- Настройка webpack
- Анализ размера бандлов
- Оптимизация зависимостей
- Создание отчетов

## Интеграция с CI/CD

### Автоматические проверки

- **Pre-commit hooks**: Автоматическая проверка качества
- **Quality gates**: Блокировка при ошибках
- **Автоматические исправления**: ESLint, Prettier
- **Отчеты**: Автоматическое создание отчетов

### Настройки

```json
{
  "lint-staged": {
    "*.{ts,tsx}": ["tsc --noEmit", "eslint --fix", "prettier --write"]
  }
}
```

## Метрики качества

### Текущие показатели

- **Покрытие codemods**: 100% (все типы файлов)
- **Трансформации**: 5 предопределенных правил
- **Анализ дублирования**: Автоматический
- **Оптимизация импортов**: Автоматическая
- **Tree-shaking**: Настроен для production

### Целевые показатели

- **0 any типов** в коде
- **< 10% дублирования** кода
- **Оптимизированные импорты** во всех файлах
- **Минимальный размер** production бандлов

## Troubleshooting

### Частые проблемы

1. **jscodeshift не установлен**:

   ```bash
   pnpm add -g jscodeshift
   ```

2. **Ошибки трансформации**:
   - Проверьте синтаксис файлов
   - Убедитесь в корректности правил
   - Используйте --backup для резервного копирования

3. **Проблемы с импортами**:
   - Запустите import-optimizer.sh
   - Проверьте циклические зависимости
   - Удалите неиспользуемые импорты

### Логи

- **Codemods**: `./scripts/codemods.sh --help`
- **Импорты**: `./scripts/quality/import-optimizer.sh`
- **Бандлы**: `./scripts/quality/bundle-optimizer.sh`
- **Качество**: `./scripts/quality/code-captain.sh`

## Следующие шаги

1. **Расширение правил**: Добавление новых трансформаций
2. **Интеграция с IDE**: Плагины для автоматизации
3. **AI-ассистент**: Автоматические предложения по улучшению
4. **Мониторинг**: Отслеживание качества кода в реальном времени

## Заключение

Система автоматизации и инструментов полностью настроена и обеспечивает высокое качество кода через автоматические проверки, трансформации и оптимизации. Все компоненты интегрированы и готовы к использованию в production.
